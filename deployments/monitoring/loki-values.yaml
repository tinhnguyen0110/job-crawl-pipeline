# monitoring/loki-values.yaml - Phi√™n b·∫£n ph√≤ng th·ªß v√† t∆∞·ªùng minh

deploymentMode: SingleBinary

loki:
  # C·∫•u h√¨nh l∆∞u tr·ªØ. B·∫Øt bu·ªôc ph·∫£i c√≥ ƒë·ªÉ c√°c template helper ho·∫°t ƒë·ªông.
  storage:
    type: 'filesystem'
  auth_enabled: false
  # ==========================================================
  # PH·∫¶N S·ª¨A L·ªñI: Th√™m v√†o schema_config c∆° b·∫£n
  # ==========================================================
  # ƒê√¢y l√† c·∫•u h√¨nh b·∫Øt bu·ªôc khi d√πng persistence
  schemaConfig:
    configs:
      - from: 2024-01-01 # B·∫Øt ƒë·∫ßu t·ª´ m·ªôt ng√†y trong qu√° kh·ª©
        store: boltdb-shipper
        object_store: filesystem
        schema: v12 # ho·∫∑c v11, t√πy phi√™n b·∫£n Loki
        index:
          prefix: index_
          period: 24h # T·∫°o index m·ªõi m·ªói 24 gi·ªù
  limits_config:
    allow_structured_metadata: false  # üëà TH√äM D√íNG N√ÄY
  commonConfig:
    path_prefix: /var/loki
  labels:
    app.kubernetes.io/component: loki
    app.kubernetes.io/name: loki

singleBinary:
  replicas: 1
  persistence:
    enabled: true
    size: 10Gi
    storageClassName: standard

# ==========================================================

podLabels:
  component: loki
  app: loki

backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0
ruler:
  enabled: false
ingester:
  enabled: false

gateway:
  enabled: false

promtail:
  enabled: true
  config:
    server:
      disable: false
      http_listen_port: 9080
      grpc_listen_port: 0
    positions:
      filename: /tmp/positions.yaml
    clients:
      - url: http://loki:3100/loki/api/v1/push
    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_container_name]
            target_label: container
          - source_labels: [__meta_kubernetes_pod_container_name]
            regex: '.*'
            action: keep
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
        pipeline_stages:
          - docker: {}
        static_configs:
          - targets: ['localhost']
            labels:
              job: varlogs
              __path__: /var/log/containers/*.log


