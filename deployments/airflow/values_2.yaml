executor: "KubernetesExecutor"

# kubernetesExecutor:
#   deleteWorkerPods: false   # <- giữ lại pod
#   workerContainerRepository: gcr.io/alpine-figure-461007-i9/custom-airflow
#   workerContainerTag: latest

images:
  airflow:
    repository: gcr.io/alpine-figure-461007-i9/custom-airflow
    tag: latest
    pullPolicy: Always

serviceAccount:
  create: false
  name: airflow-ksa

workers:
  serviceAccount:
    create: false
    name: airflow-ksa

scheduler:
  serviceAccount:
    create: false
    name: airflow-ksa

webserver:
  serviceAccount:
    create: false
    name: airflow-ksa

triggerer:
  serviceAccount:
    create: false
    name: airflow-ksa



extraPipPackages:
  - dateparser
  - playwright


dags:
  persistence:
      enabled: false # Không cần lưu trữ DAGs trên disk
  gitSync:
    enabled: true
    repo: git@github.com:tinhnguyen0110/job-crawl-pipeline.git
    branch: deploy_gke
    subPath: airflow/dags  # thư mục chứa DAGs trong repo
    depth: 1
    wait: 10
    sshKeySecret: airflow-git-ssh-key
    # sshKnownHosts: |
    #   github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
    rev: HEAD


# logs:
#   persistence:
#     enabled: true
#     # Thêm dòng này để chỉ yêu cầu ổ đĩa cho một node duy nhất
#     size: 1Gi
#     storageClassName: "standard"
logs:
  persistence:
    enabled: false

config:
  kubernetes:
    # Giữ lại các pod đã hoàn thành để debug
    delete_worker_pods: "False"
  # Cấu hình cho việc ghi log
  logging:
    remote_logging: "True"
    # Đường dẫn đến bucket GCS của bạn
    remote_base_log_folder: "gs://airflow-logs-tinhnv-gke/logs"
    # Sử dụng connection mặc định của môi trường Google Cloud
    # Airflow sẽ tự động dùng Workload Identity để xác thực
    remote_log_conn_id: "google_cloud_default"

postgresql:
  enabled: true  # ❌ Tắt PostgreSQL tích hợp, bạn đã có Cloud SQL riêng
  persistence:
      # Buộc yêu cầu loại ổ đĩa chỉ cho phép 1 node ghi tại 1 thời điểm
      # Điều này tương thích với StorageClass "standard-rwo" mặc định của GKE
      accessModes:
        - ReadWriteOnce

workers:
  serviceAccount:
    create: false
    name: airflow-ksa
  extraContainers:
    - name: cloud-sql-proxy
      image: "gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.10.0"
      command:
        - "/cloud_sql_proxy"
        - "--structured-logs"
        - "-instances=alpine-figure-461007-i9:asia-southeast1:job-pipeline-db=tcp:5432"
      securityContext:
        runAsNonRoot: true

# webserver:
#   extraContainers:
#     - name: cloud-sql-proxy
#       image: "gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.10.0"
#       command:
#         - "/cloud_sql_proxy"
#         - "--structured-logs"
#         - "-instances=alpine-figure-461007-i9:asia-southeast1:job-pipeline-db=tcp:5432"
#       securityContext:
#         runAsNonRoot: true

# scheduler:
#   extraContainers:
#     - name: cloud-sql-proxy
#       image: "gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.10.0"
#       command:
#         - "/cloud_sql_proxy"
#         - "--structured-logs"
#         - "-instances=alpine-figure-461007-i9:asia-southeast1:job-pipeline-db=tcp:5432"
#       securityContext:
#         runAsNonRoot: true

