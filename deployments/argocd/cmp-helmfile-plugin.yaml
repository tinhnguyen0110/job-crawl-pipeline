apiVersion: v1
kind: ConfigMap
metadata:
  name: cmp-helmfile-plugin
  namespace: argocd
data:
  # plugin.yaml: |
  #   apiVersion: argoproj.io/v1alpha1
  #   kind: ConfigManagementPlugin
  #   metadata:
  #     name: helmfile
  #   spec:
  #     discover:
  #       find: 
  #         command: ["sh", "-c", "echo '[ðŸ”] Discovering helmfile...'; find . -maxdepth 2 -name 'helmfile.yaml'"]
  #     init:
  #       command: ["helmfile", "repos"]
  #     generate:
  #       #command: ["helmfile", "template", "--include-crds"]
  #       command: ["sh", "-c", "helmfile -e development -l app=$ARGOCD_APP_NAME template --include-crds"]
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: helmfile
    spec:
      init:
        command: ["helmfile", "repos"]
      
      generate:
        command: ["sh", "-c"]
        args:
          - |
            # Sá»¬A Lá»–I á»ž ÄÃ‚Y: Chuyá»ƒn hÆ°á»›ng táº¥t cáº£ cÃ¡c dÃ²ng echo sang stderr báº±ng `>&2`
            echo "--- Processing Application: $ARGOCD_APP_NAME ---" >&2
            
            if [ -f "Chart.yaml" ]; then
              echo "==> Detected standard Helm chart. Using 'helm template'..." >&2
              # Lá»‡nh helm template váº«n in YAML ra stdout nhÆ° bÃ¬nh thÆ°á»ng
              helm template .
            else
              echo "==> Helmfile project detected. Using 'helmfile template' with selector: app=$ARGOCD_APP_NAME" >&2
              # Lá»‡nh helmfile template váº«n in YAML ra stdout nhÆ° bÃ¬nh thÆ°á»ng
              helmfile -e development -l app=$ARGOCD_APP_NAME template --include-crds
            fi
            echo "--- Finished processing Application: $ARGOCD_APP_NAME ---" >&2
