PROJECT_ID: alpine-figure-461007-i9 


### Kiểm tra trạng thái
kubectl create namespace model-serving
kubectl get pods -n model-serving
kubectl port-forward svc/litellm-proxy-deployment 9000:4000 -n model-serving

### tạo Workload Identity
1. Tạo IAM Service Account (GSA):
    gcloud iam service-accounts create litellm-proxy-gsa \
    --project=alpine-figure-461007-i9

    gcloud projects add-iam-policy-binding alpine-figure-461007-i9 --member="serviceAccount:cloudsql-proxy-gsa@alpine-figure-461007-i9.iam.gserviceaccount.com" --role="roles/container.developer"
    gcloud projects add-iam-policy-binding alpine-figure-461007-i9 --member="serviceAccount:cloudsql-proxy-gsa@alpine-figure-461007-i9.iam.gserviceaccount.com" --role="roles/cloudsql.client"

2. Tạo Kubernetes Service Account (KSA):
    kubectl create serviceaccount litellm-proxy-ksa -n airflow
    
3. Liên kết GSA với KSA:
    gcloud iam service-accounts add-iam-policy-binding \
    litellm-proxy-gsa@alpine-figure-461007-i9.iam.gserviceaccount.com \
    --role=roles/iam.workloadIdentityUser \
    --member="serviceAccount:alpine-figure-461007-i9.svc.id.goog:litellm-proxy-ksa"


4. thêm annotate ksa
    kubectl annotate serviceaccount litellm-proxy-ksa \
    --namespace airflow \
    iam.gke.io/gcp-service-account=litellm-proxy-gsa@alpine-figure-461007-i9.iam.gserviceaccount.com

### Deploy airflow to gke
docker build -t gcr.io/alpine-figure-461007-i9/custom-airflow:v1 .
docker push gcr.io/alpine-figure-461007-i9/custom-airflow:v1

kubectl create namespace airflow

## Tạo các secret
kubectl create secret generic airflow-db-connection -n airflow ^
  --from-literal=connection='postgresql+psycopg2://postgres:123456@127.0.0.1:5432/airflow'

kubectl create secret generic airflow-git-ssh-key --namespace airflow ^
  --from-file=gitSshKey=./airflow-gitsync

kubectl create secret generic airflow-fernet-key ^
  --from-literal=value='PpwOpKTKaHYo-TuiwCIMSwxNmBJknIf4rV5KctQ_8-k='

kubectl create secret generic airflow-webserver-secret-key ^
  --from-literal=value='b60a4906211cf835536284864f38c421'

kubectl get secret airflow-webserver-secret-key -n airflow -o yaml


kubectl delete secret airflow-db-connection airflow-git-ssh-key airflow-fernet-key airflow-webserver-secret-key --namespace airflow
kubectl delete secret airflow-webserver-secret-key --namespace airflow

kubectl delete pvc -n airflow --all
helm uninstall airflow -n airflow

helm repo add apache-airflow https://airflow.apache.org
helm repo update

helm upgrade --install airflow apache-airflow/airflow ^
  -n airflow ^
  -f deployments/airflow/values_2.yaml ^
  --debug --timeout 7m

## Tạo Gitsync cho Airflow
    kubectl create secret generic git-credentials --from-file=.git.env -n airflow

    # Tạo secret chứa SSH key
    kubectl create secret generic git-ssh-key-secret \
    --from-file=id_rsa=./airflow-gitsync \
    --namespace airflow

# kubectl exec -it airflow-scheduler-7c446bc5f9-t6sz5 -- bash
kubectl port-forward svc/airflow-webserver 8000:8080 -n airflow

airflow users create \
    --username admin1 \
    --firstname Admin \
    --lastname User \
    --role Admin \
    --email admin@example.com